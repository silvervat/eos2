generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =============================================
// MULTI-TENANT CORE
// =============================================

model Tenant {
  id                    String    @id @default(uuid()) @db.Uuid
  name                  String
  slug                  String    @unique
  domain                String?   @unique
  logoUrl               String?   @map("logo_url")
  primaryColor          String    @default("#279989") @map("primary_color")
  secondaryColor        String    @default("#333F48") @map("secondary_color")
  settings              Json      @default("{}")
  features              Json      @default("{}")
  maxUsers              Int       @default(50) @map("max_users")
  maxProjects           Int       @default(100) @map("max_projects")
  maxStorageGb          Int       @default(10) @map("max_storage_gb")
  status                String    @default("active")
  subscriptionTier      String    @default("basic") @map("subscription_tier")
  trialEndsAt           DateTime? @map("trial_ends_at")
  subscriptionStartsAt  DateTime? @map("subscription_starts_at")
  subscriptionEndsAt    DateTime? @map("subscription_ends_at")
  billingEmail          String?   @map("billing_email")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  deletedAt             DateTime? @map("deleted_at")

  // Relations
  users    UserProfile[]
  projects Project[]
  companies Company[]
  invoices Invoice[]
  employees Employee[]

  // Ultra Table Relations
  ultraTables        UltraTable[]
  ultraDialogs       UltraDialog[]
  ultraColumnConfigs UltraColumnTypeConfig[]
  userGroups         UserGroup[]

  @@map("tenants")
}

model UserProfile {
  id              String    @id @default(uuid()) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  authUserId      String    @unique @map("auth_user_id") @db.Uuid
  email           String
  fullName        String?   @map("full_name")
  avatarUrl       String?   @map("avatar_url")
  role            String    @default("user")
  permissions     Json      @default("[]")
  settings        Json      @default("{}")
  lastLoginAt     DateTime? @map("last_login_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Ultra Table Relations
  groupMemberships    UserGroupMember[]
  tablePermissions    UltraTablePermission[] @relation("UserTablePermissions")
  columnPermissions   UltraColumnPermission[] @relation("UserColumnPermissions")

  @@index([tenantId])
  @@index([authUserId])
  @@map("user_profiles")
}

// =============================================
// BUSINESS ENTITIES
// =============================================

model Project {
  id              String    @id @default(uuid()) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  code            String
  name            String
  description     String?
  clientId        String?   @map("client_id") @db.Uuid
  status          String    @default("draft")
  budget          Decimal?  @db.Decimal(15, 2)
  currency        String    @default("EUR")
  startDate       DateTime? @map("start_date")
  endDate         DateTime? @map("end_date")
  address         String?
  city            String?
  country         String    @default("Estonia")
  managerId       String?   @map("manager_id") @db.Uuid
  metadata        Json      @default("{}")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client   Company?  @relation(fields: [clientId], references: [id])
  invoices Invoice[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([status])
  @@map("projects")
}

model Company {
  id              String    @id @default(uuid()) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  registryCode    String?   @map("registry_code")
  vatNumber       String?   @map("vat_number")
  name            String
  type            String    @default("client") // client, supplier, subcontractor
  email           String?
  phone           String?
  address         String?
  city            String?
  country         String    @default("Estonia")
  bankAccount     String?   @map("bank_account")
  paymentTermDays Int       @default(14) @map("payment_term_days")
  creditLimit     Decimal?  @db.Decimal(15, 2) @map("credit_limit")
  notes           String?
  metadata        Json      @default("{}")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  projects Project[]
  invoices Invoice[]

  @@unique([tenantId, registryCode])
  @@index([tenantId])
  @@index([type])
  @@map("companies")
}

model Invoice {
  id              String    @id @default(uuid()) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  invoiceNumber   String    @map("invoice_number")
  type            String    @default("sales") // sales, purchase
  status          String    @default("draft") // draft, sent, paid, overdue, cancelled
  projectId       String?   @map("project_id") @db.Uuid
  companyId       String?   @map("company_id") @db.Uuid
  issueDate       DateTime  @map("issue_date")
  dueDate         DateTime  @map("due_date")
  subtotal        Decimal   @db.Decimal(15, 2)
  vatAmount       Decimal   @db.Decimal(15, 2) @map("vat_amount")
  total           Decimal   @db.Decimal(15, 2)
  currency        String    @default("EUR")
  paidAmount      Decimal   @default(0) @db.Decimal(15, 2) @map("paid_amount")
  paidAt          DateTime? @map("paid_at")
  notes           String?
  lineItems       Json      @default("[]") @map("line_items")
  metadata        Json      @default("{}")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id])
  company Company? @relation(fields: [companyId], references: [id])

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

model Employee {
  id              String    @id @default(uuid()) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  employeeCode    String    @map("employee_code")
  firstName       String    @map("first_name")
  lastName        String    @map("last_name")
  email           String?
  phone           String?
  personalCode    String?   @map("personal_code")
  position        String?
  department      String?
  employmentType  String    @default("full_time") @map("employment_type")
  startDate       DateTime? @map("start_date")
  endDate         DateTime? @map("end_date")
  hourlyRate      Decimal?  @db.Decimal(10, 2) @map("hourly_rate")
  monthlyRate     Decimal?  @db.Decimal(10, 2) @map("monthly_rate")
  status          String    @default("active")
  metadata        Json      @default("{}")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, employeeCode])
  @@index([tenantId])
  @@index([status])
  @@map("employees")
}

// =============================================
// AUDIT LOG
// =============================================

model AuditLog {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  userId      String?  @map("user_id") @db.Uuid
  action      String   // create, update, delete, view
  entityType  String   @map("entity_type")
  entityId    String   @map("entity_id") @db.Uuid
  oldValues   Json?    @map("old_values")
  newValues   Json?    @map("new_values")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_log")
}

// =============================================
// ULTRA TABLE SYSTEM - Rivest Dynamic Tables
// =============================================

// Enums for Ultra Table System
enum ColumnPermissionType {
  hidden // Column not visible
  view   // Read-only
  edit   // Can edit
}

enum RowPolicyType {
  owner      // User is the owner (created_by)
  assigned   // User is assigned
  department // User in same department
  manager    // User is manager
  custom     // Custom condition
}

// Table configuration (metadata)
model UltraTable {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  name        String
  description String?

  // Configuration (TableConfig JSON)
  config      Json     @default("{}")

  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdBy   String   @map("created_by") @db.Uuid

  // Relations
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  columns     UltraTableColumn[]
  rows        UltraTableRow[]
  views       UltraTableView[]
  permissions UltraTablePermission[]
  rowPolicies UltraRowPolicy[]

  @@index([tenantId])
  @@map("ultra_tables")
}

// Column definitions (55+ types)
model UltraTableColumn {
  id              String   @id @default(uuid()) @db.Uuid
  tableId         String   @map("table_id") @db.Uuid

  // Basic
  name            String   // Display name
  key             String   // Data key (slug)
  type            String   // ColumnType enum (stored as string)

  // Configuration
  config          Json     @default("{}") // Type-specific config
  formula         String?  // Formula expression
  validation      Json?    // Validation rules

  // Display
  width           Int?     // Column width (px)
  visible         Boolean  @default(true)
  pinned          String?  // 'left' | 'right'
  order           Int      @default(0) // Display order

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  table           UltraTable @relation(fields: [tableId], references: [id], onDelete: Cascade)
  columnPermissions UltraColumnPermission[]

  @@unique([tableId, key])
  @@index([tableId])
  @@map("ultra_table_columns")
}

// Row data
model UltraTableRow {
  id              String   @id @default(uuid()) @db.Uuid
  tableId         String   @map("table_id") @db.Uuid

  // Hierarchical support (sub-rows)
  parentId        String?  @map("parent_id") @db.Uuid
  level           Int      @default(0)
  order           Int      @default(0) // Display order

  // Data storage (JSONB for flexibility)
  data            Json     @default("{}")

  // Metadata
  height          Int?     // Custom row height (px)
  expanded        Boolean  @default(false)

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  createdBy       String   @map("created_by") @db.Uuid

  // Relations
  table           UltraTable @relation(fields: [tableId], references: [id], onDelete: Cascade)
  parent          UltraTableRow? @relation("RowHierarchy", fields: [parentId], references: [id])
  children        UltraTableRow[] @relation("RowHierarchy")

  @@index([tableId])
  @@index([parentId])
  @@index([tableId, order])
  @@map("ultra_table_rows")
}

// Table views (different configurations)
model UltraTableView {
  id              String   @id @default(uuid()) @db.Uuid
  tableId         String   @map("table_id") @db.Uuid

  name            String
  description     String?

  // View configuration (ViewConfig JSON)
  config          Json     @default("{}")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  createdBy       String   @map("created_by") @db.Uuid

  // Relations
  table           UltraTable @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@index([tableId])
  @@map("ultra_table_views")
}

// Dialog configurations
model UltraDialog {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  tableId         String?  @map("table_id") @db.Uuid

  name            String
  type            String   // 'create' | 'edit' | 'view' | 'custom'

  // Visual designer configuration (DialogConfig JSON)
  config          Json     @default("{}")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  createdBy       String   @map("created_by") @db.Uuid

  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tableId])
  @@map("ultra_dialogs")
}

// Column type configurations (dropdowns, tags, etc)
model UltraColumnTypeConfig {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid

  name            String   // e.g., "Project Status", "Priority Levels"
  type            String   // 'dropdown' | 'tags' | 'status'

  // Options (JSON array)
  options         Json     @default("[]")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("ultra_column_type_configs")
}

// =============================================
// ULTRA TABLE PERMISSIONS SYSTEM
// =============================================

// User Groups
model UserGroup {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  name            String
  description     String?
  isAdmin         Boolean  @default(false) @map("is_admin")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  members         UserGroupMember[]
  tablePermissions UltraTablePermission[]
  columnPermissions UltraColumnPermission[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("user_groups")
}

// User Group Members
model UserGroupMember {
  id              String    @id @default(uuid()) @db.Uuid
  groupId         String    @map("group_id") @db.Uuid
  userId          String    @map("user_id") @db.Uuid

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  group           UserGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user            UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@map("user_group_members")
}

// Table-level permissions
model UltraTablePermission {
  id              String    @id @default(uuid()) @db.Uuid
  tableId         String    @map("table_id") @db.Uuid
  groupId         String?   @map("group_id") @db.Uuid  // null = applies to all users
  userId          String?   @map("user_id") @db.Uuid   // specific user override

  // Permission flags
  canView         Boolean   @default(false) @map("can_view")
  canCreate       Boolean   @default(false) @map("can_create")
  canEdit         Boolean   @default(false) @map("can_edit")
  canDelete       Boolean   @default(false) @map("can_delete")
  isAdmin         Boolean   @default(false) @map("is_admin")  // Full control

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  table           UltraTable @relation(fields: [tableId], references: [id], onDelete: Cascade)
  group           UserGroup? @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user            UserProfile? @relation("UserTablePermissions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tableId, groupId, userId])
  @@index([tableId])
  @@index([groupId])
  @@index([userId])
  @@map("ultra_table_permissions")
}

// Column-level permissions
model UltraColumnPermission {
  id              String    @id @default(uuid()) @db.Uuid
  columnId        String    @map("column_id") @db.Uuid
  groupId         String?   @map("group_id") @db.Uuid
  userId          String?   @map("user_id") @db.Uuid

  // Permission type
  permission      ColumnPermissionType

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  column          UltraTableColumn @relation(fields: [columnId], references: [id], onDelete: Cascade)
  group           UserGroup? @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user            UserProfile? @relation("UserColumnPermissions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([columnId, groupId, userId])
  @@index([columnId])
  @@index([groupId])
  @@index([userId])
  @@map("ultra_column_permissions")
}

// Row-level security policies
model UltraRowPolicy {
  id              String    @id @default(uuid()) @db.Uuid
  tableId         String    @map("table_id") @db.Uuid
  name            String
  description     String?

  // Policy type
  type            RowPolicyType

  // Condition (JSON)
  // Examples:
  // { "field": "created_by", "operator": "equals", "value": "{{current_user_id}}" }
  // { "field": "department", "operator": "in", "value": "{{user_departments}}" }
  condition       Json      @default("{}")

  // What this policy allows
  allowView       Boolean   @default(false) @map("allow_view")
  allowEdit       Boolean   @default(false) @map("allow_edit")
  allowDelete     Boolean   @default(false) @map("allow_delete")

  // Priority (higher = evaluated first)
  priority        Int       @default(0)
  enabled         Boolean   @default(true)

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  table           UltraTable @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@index([tableId])
  @@index([tableId, enabled, priority])
  @@map("ultra_row_policies")
}
