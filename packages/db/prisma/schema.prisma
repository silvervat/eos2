generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =============================================
// MULTI-TENANT CORE
// =============================================

model Tenant {
  id                    String    @id @default(uuid()) @db.Uuid
  name                  String
  slug                  String    @unique
  domain                String?   @unique
  logoUrl               String?   @map("logo_url")
  primaryColor          String    @default("#279989") @map("primary_color")
  secondaryColor        String    @default("#333F48") @map("secondary_color")
  settings              Json      @default("{}")
  features              Json      @default("{}")
  maxUsers              Int       @default(50) @map("max_users")
  maxProjects           Int       @default(100) @map("max_projects")
  maxStorageGb          Int       @default(10) @map("max_storage_gb")
  status                String    @default("active")
  subscriptionTier      String    @default("basic") @map("subscription_tier")
  trialEndsAt           DateTime? @map("trial_ends_at")
  subscriptionStartsAt  DateTime? @map("subscription_starts_at")
  subscriptionEndsAt    DateTime? @map("subscription_ends_at")
  billingEmail          String?   @map("billing_email")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  deletedAt             DateTime? @map("deleted_at")

  // Relations
  users    UserProfile[]
  projects Project[]
  companies Company[]
  invoices Invoice[]
  employees Employee[]

  // Ultra Table Relations
  ultraTables        UltraTable[]
  ultraDialogs       UltraDialog[]
  ultraColumnConfigs UltraColumnTypeConfig[]
  userGroups         UserGroup[]

  // File Vault Relations
  fileVaults         FileVault[]
  fileTeams          FileTeam[]

  @@map("tenants")
}

model UserProfile {
  id              String    @id @default(uuid()) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  authUserId      String    @unique @map("auth_user_id") @db.Uuid
  email           String
  fullName        String?   @map("full_name")
  avatarUrl       String?   @map("avatar_url")
  role            String    @default("user")
  permissions     Json      @default("[]")
  settings        Json      @default("{}")
  lastLoginAt     DateTime? @map("last_login_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Ultra Table Relations
  groupMemberships    UserGroupMember[]
  tablePermissions    UltraTablePermission[] @relation("UserTablePermissions")
  columnPermissions   UltraColumnPermission[] @relation("UserColumnPermissions")

  @@index([tenantId])
  @@index([authUserId])
  @@map("user_profiles")
}

// =============================================
// BUSINESS ENTITIES
// =============================================

model Project {
  id              String    @id @default(uuid()) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  code            String
  name            String
  description     String?
  clientId        String?   @map("client_id") @db.Uuid
  status          String    @default("draft")
  budget          Decimal?  @db.Decimal(15, 2)
  currency        String    @default("EUR")
  startDate       DateTime? @map("start_date")
  endDate         DateTime? @map("end_date")
  address         String?
  city            String?
  country         String    @default("Estonia")
  managerId       String?   @map("manager_id") @db.Uuid
  metadata        Json      @default("{}")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client   Company?  @relation(fields: [clientId], references: [id])
  invoices Invoice[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([status])
  @@map("projects")
}

model Company {
  id              String    @id @default(uuid()) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  registryCode    String?   @map("registry_code")
  vatNumber       String?   @map("vat_number")
  name            String
  type            String    @default("client") // client, supplier, subcontractor
  email           String?
  phone           String?
  address         String?
  city            String?
  country         String    @default("Estonia")
  bankAccount     String?   @map("bank_account")
  paymentTermDays Int       @default(14) @map("payment_term_days")
  creditLimit     Decimal?  @db.Decimal(15, 2) @map("credit_limit")
  notes           String?
  metadata        Json      @default("{}")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  projects Project[]
  invoices Invoice[]

  @@unique([tenantId, registryCode])
  @@index([tenantId])
  @@index([type])
  @@map("companies")
}

model Invoice {
  id              String    @id @default(uuid()) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  invoiceNumber   String    @map("invoice_number")
  type            String    @default("sales") // sales, purchase
  status          String    @default("draft") // draft, sent, paid, overdue, cancelled
  projectId       String?   @map("project_id") @db.Uuid
  companyId       String?   @map("company_id") @db.Uuid
  issueDate       DateTime  @map("issue_date")
  dueDate         DateTime  @map("due_date")
  subtotal        Decimal   @db.Decimal(15, 2)
  vatAmount       Decimal   @db.Decimal(15, 2) @map("vat_amount")
  total           Decimal   @db.Decimal(15, 2)
  currency        String    @default("EUR")
  paidAmount      Decimal   @default(0) @db.Decimal(15, 2) @map("paid_amount")
  paidAt          DateTime? @map("paid_at")
  notes           String?
  lineItems       Json      @default("[]") @map("line_items")
  metadata        Json      @default("{}")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id])
  company Company? @relation(fields: [companyId], references: [id])

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

model Employee {
  id              String    @id @default(uuid()) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  employeeCode    String    @map("employee_code")
  firstName       String    @map("first_name")
  lastName        String    @map("last_name")
  email           String?
  phone           String?
  personalCode    String?   @map("personal_code")
  position        String?
  department      String?
  employmentType  String    @default("full_time") @map("employment_type")
  startDate       DateTime? @map("start_date")
  endDate         DateTime? @map("end_date")
  hourlyRate      Decimal?  @db.Decimal(10, 2) @map("hourly_rate")
  monthlyRate     Decimal?  @db.Decimal(10, 2) @map("monthly_rate")
  status          String    @default("active")
  metadata        Json      @default("{}")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, employeeCode])
  @@index([tenantId])
  @@index([status])
  @@map("employees")
}

// =============================================
// AUDIT LOG
// =============================================

model AuditLog {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  userId      String?  @map("user_id") @db.Uuid
  action      String   // create, update, delete, view
  entityType  String   @map("entity_type")
  entityId    String   @map("entity_id") @db.Uuid
  oldValues   Json?    @map("old_values")
  newValues   Json?    @map("new_values")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_log")
}

// =============================================
// ULTRA TABLE SYSTEM - Rivest Dynamic Tables
// =============================================

// Enums for Ultra Table System
enum ColumnPermissionType {
  hidden // Column not visible
  view   // Read-only
  edit   // Can edit
}

enum RowPolicyType {
  owner      // User is the owner (created_by)
  assigned   // User is assigned
  department // User in same department
  manager    // User is manager
  custom     // Custom condition
}

// Table configuration (metadata)
model UltraTable {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  name        String
  description String?

  // Configuration (TableConfig JSON)
  config      Json     @default("{}")

  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdBy   String   @map("created_by") @db.Uuid

  // Relations
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  columns     UltraTableColumn[]
  rows        UltraTableRow[]
  views       UltraTableView[]
  permissions UltraTablePermission[]
  rowPolicies UltraRowPolicy[]

  @@index([tenantId])
  @@map("ultra_tables")
}

// Column definitions (55+ types)
model UltraTableColumn {
  id              String   @id @default(uuid()) @db.Uuid
  tableId         String   @map("table_id") @db.Uuid

  // Basic
  name            String   // Display name
  key             String   // Data key (slug)
  type            String   // ColumnType enum (stored as string)

  // Configuration
  config          Json     @default("{}") // Type-specific config
  formula         String?  // Formula expression
  validation      Json?    // Validation rules

  // Display
  width           Int?     // Column width (px)
  visible         Boolean  @default(true)
  pinned          String?  // 'left' | 'right'
  order           Int      @default(0) // Display order

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  table           UltraTable @relation(fields: [tableId], references: [id], onDelete: Cascade)
  columnPermissions UltraColumnPermission[]

  @@unique([tableId, key])
  @@index([tableId])
  @@map("ultra_table_columns")
}

// Row data
model UltraTableRow {
  id              String   @id @default(uuid()) @db.Uuid
  tableId         String   @map("table_id") @db.Uuid

  // Hierarchical support (sub-rows)
  parentId        String?  @map("parent_id") @db.Uuid
  level           Int      @default(0)
  order           Int      @default(0) // Display order

  // Data storage (JSONB for flexibility)
  data            Json     @default("{}")

  // Metadata
  height          Int?     // Custom row height (px)
  expanded        Boolean  @default(false)

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  createdBy       String   @map("created_by") @db.Uuid

  // Relations
  table           UltraTable @relation(fields: [tableId], references: [id], onDelete: Cascade)
  parent          UltraTableRow? @relation("RowHierarchy", fields: [parentId], references: [id])
  children        UltraTableRow[] @relation("RowHierarchy")

  @@index([tableId])
  @@index([parentId])
  @@index([tableId, order])
  @@map("ultra_table_rows")
}

// Table views (different configurations)
model UltraTableView {
  id              String   @id @default(uuid()) @db.Uuid
  tableId         String   @map("table_id") @db.Uuid

  name            String
  description     String?

  // View configuration (ViewConfig JSON)
  config          Json     @default("{}")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  createdBy       String   @map("created_by") @db.Uuid

  // Relations
  table           UltraTable @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@index([tableId])
  @@map("ultra_table_views")
}

// Dialog configurations
model UltraDialog {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  tableId         String?  @map("table_id") @db.Uuid

  name            String
  type            String   // 'create' | 'edit' | 'view' | 'custom'

  // Visual designer configuration (DialogConfig JSON)
  config          Json     @default("{}")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  createdBy       String   @map("created_by") @db.Uuid

  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tableId])
  @@map("ultra_dialogs")
}

// Column type configurations (dropdowns, tags, etc)
model UltraColumnTypeConfig {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid

  name            String   // e.g., "Project Status", "Priority Levels"
  type            String   // 'dropdown' | 'tags' | 'status'

  // Options (JSON array)
  options         Json     @default("[]")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("ultra_column_type_configs")
}

// =============================================
// ULTRA TABLE PERMISSIONS SYSTEM
// =============================================

// User Groups
model UserGroup {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  name            String
  description     String?
  isAdmin         Boolean  @default(false) @map("is_admin")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  members         UserGroupMember[]
  tablePermissions UltraTablePermission[]
  columnPermissions UltraColumnPermission[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("user_groups")
}

// User Group Members
model UserGroupMember {
  id              String    @id @default(uuid()) @db.Uuid
  groupId         String    @map("group_id") @db.Uuid
  userId          String    @map("user_id") @db.Uuid

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  group           UserGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user            UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@map("user_group_members")
}

// Table-level permissions
model UltraTablePermission {
  id              String    @id @default(uuid()) @db.Uuid
  tableId         String    @map("table_id") @db.Uuid
  groupId         String?   @map("group_id") @db.Uuid  // null = applies to all users
  userId          String?   @map("user_id") @db.Uuid   // specific user override

  // Permission flags
  canView         Boolean   @default(false) @map("can_view")
  canCreate       Boolean   @default(false) @map("can_create")
  canEdit         Boolean   @default(false) @map("can_edit")
  canDelete       Boolean   @default(false) @map("can_delete")
  isAdmin         Boolean   @default(false) @map("is_admin")  // Full control

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  table           UltraTable @relation(fields: [tableId], references: [id], onDelete: Cascade)
  group           UserGroup? @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user            UserProfile? @relation("UserTablePermissions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tableId, groupId, userId])
  @@index([tableId])
  @@index([groupId])
  @@index([userId])
  @@map("ultra_table_permissions")
}

// Column-level permissions
model UltraColumnPermission {
  id              String    @id @default(uuid()) @db.Uuid
  columnId        String    @map("column_id") @db.Uuid
  groupId         String?   @map("group_id") @db.Uuid
  userId          String?   @map("user_id") @db.Uuid

  // Permission type
  permission      ColumnPermissionType

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  column          UltraTableColumn @relation(fields: [columnId], references: [id], onDelete: Cascade)
  group           UserGroup? @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user            UserProfile? @relation("UserColumnPermissions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([columnId, groupId, userId])
  @@index([columnId])
  @@index([groupId])
  @@index([userId])
  @@map("ultra_column_permissions")
}

// Row-level security policies
model UltraRowPolicy {
  id              String    @id @default(uuid()) @db.Uuid
  tableId         String    @map("table_id") @db.Uuid
  name            String
  description     String?

  // Policy type
  type            RowPolicyType

  // Condition (JSON)
  // Examples:
  // { "field": "created_by", "operator": "equals", "value": "{{current_user_id}}" }
  // { "field": "department", "operator": "in", "value": "{{user_departments}}" }
  condition       Json      @default("{}")

  // What this policy allows
  allowView       Boolean   @default(false) @map("allow_view")
  allowEdit       Boolean   @default(false) @map("allow_edit")
  allowDelete     Boolean   @default(false) @map("allow_delete")

  // Priority (higher = evaluated first)
  priority        Int       @default(0)
  enabled         Boolean   @default(true)

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  table           UltraTable @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@index([tableId])
  @@index([tableId, enabled, priority])
  @@map("ultra_row_policies")
}

// =============================================
// FILE VAULT SYSTEM - Enterprise File Management
// =============================================

// Enums for File Vault
enum SharePermission {
  view      // Can view only
  download  // Can download
  edit      // Can upload/edit
}

enum FileAction {
  view
  download
  upload
  delete
  share
  rename
  move
}

enum UploadStatus {
  in_progress
  completed
  failed
  cancelled
}

// File Vault (Storage container)
model FileVault {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  name        String
  description String?

  // Vault configuration (VaultConfig JSON)
  config      Json     @default("{}")

  // Storage quota (bytes)
  quotaBytes  BigInt   @default(107374182400) @map("quota_bytes") // 100GB default
  usedBytes   BigInt   @default(0) @map("used_bytes")

  // Timestamps & Audit (PIIBEL standard)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdBy   String   @map("created_by") @db.Uuid
  updatedBy   String?  @map("updated_by") @db.Uuid

  // Soft delete (PIIBEL standard)
  deletedAt   DateTime? @map("deleted_at")
  deletedBy   String?   @map("deleted_by") @db.Uuid

  // Relations
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  folders     FileFolder[]
  files       File[]
  shares      FileShare[]

  @@index([tenantId])
  @@index([deletedAt])
  @@map("file_vaults")
}

// File Folder (Hierarchy)
model FileFolder {
  id          String   @id @default(uuid()) @db.Uuid
  vaultId     String   @map("vault_id") @db.Uuid
  parentId    String?  @map("parent_id") @db.Uuid

  name        String
  path        String   // Full path: /parent/child
  color       String?  // Folder color
  icon        String?  // Folder icon

  // Permissions
  isPublic    Boolean  @default(false) @map("is_public")
  ownerId     String   @map("owner_id") @db.Uuid

  // Timestamps & Audit (PIIBEL standard)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdBy   String   @map("created_by") @db.Uuid
  updatedBy   String?  @map("updated_by") @db.Uuid

  // Soft delete (PIIBEL standard)
  deletedAt   DateTime? @map("deleted_at")
  deletedBy   String?   @map("deleted_by") @db.Uuid

  // Relations
  vault       FileVault @relation(fields: [vaultId], references: [id], onDelete: Cascade)
  parent      FileFolder? @relation("FolderHierarchy", fields: [parentId], references: [id])
  children    FileFolder[] @relation("FolderHierarchy")
  files       File[]
  shares      FileShare[]
  permissions FilePermission[]

  @@unique([vaultId, path])
  @@index([vaultId])
  @@index([parentId])
  @@index([ownerId])
  @@index([deletedAt])
  @@map("file_folders")
}

// File (Core file entity)
model File {
  id              String   @id @default(uuid()) @db.Uuid
  vaultId         String   @map("vault_id") @db.Uuid
  folderId        String?  @map("folder_id") @db.Uuid

  // File info
  name            String
  path            String   // Full path: /folder/subfolder/file.pdf

  // Storage
  storageProvider String   @default("supabase") @map("storage_provider")
  storageBucket   String   @map("storage_bucket")
  storagePath     String   @map("storage_path")
  storageKey      String   @unique @map("storage_key")

  // File metadata
  mimeType        String   @map("mime_type")
  sizeBytes       BigInt   @map("size_bytes")
  extension       String

  // Checksums
  checksumMd5     String   @map("checksum_md5")
  checksumSha256  String?  @map("checksum_sha256")

  // Media metadata (images/videos)
  width           Int?
  height          Int?
  duration        Int?     // Duration in seconds (for video/audio)

  // EXIF metadata (for images)
  exifData        Json?    @map("exif_data")        // Complete EXIF data
  cameraMake      String?  @map("camera_make")      // "Canon"
  cameraModel     String?  @map("camera_model")     // "EOS 5D Mark IV"
  lens            String?                           // "EF 24-70mm f/2.8L"
  iso             Int?                              // 800
  aperture        String?                           // "f/2.8"
  shutterSpeed    String?  @map("shutter_speed")    // "1/250"
  focalLength     String?  @map("focal_length")     // "50mm"
  takenAt         DateTime? @map("taken_at")        // When photo was taken

  // GPS location (from EXIF)
  gpsLatitude     Float?   @map("gps_latitude")     // 59.4370
  gpsLongitude    Float?   @map("gps_longitude")    // 24.7536
  gpsLocation     String?  @map("gps_location")     // "Tallinn, Estonia"

  // Download source tracking
  downloadUrl     String?  @map("download_url")     // Where file was downloaded from
  downloadDate    DateTime? @map("download_date")   // When it was downloaded

  // Thumbnails
  thumbnailSmall  String?  @map("thumbnail_small")  // 150x150
  thumbnailMedium String?  @map("thumbnail_medium") // 500x500
  thumbnailLarge  String?  @map("thumbnail_large")  // 1000x1000

  // Custom metadata (Ultra Table integration!)
  metadata        Json     @default("{}")

  // Versioning
  version         Int      @default(1)
  isLatest        Boolean  @default(true) @map("is_latest")
  parentFileId    String?  @map("parent_file_id") @db.Uuid

  // Security
  isPublic        Boolean  @default(false) @map("is_public")
  ownerId         String   @map("owner_id") @db.Uuid

  // Virus scan
  scannedAt       DateTime? @map("scanned_at")
  isSafe          Boolean  @default(true) @map("is_safe")

  // Search indexing
  indexedAt       DateTime? @map("indexed_at")

  // Timestamps & Audit (PIIBEL standard)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  createdBy       String   @map("created_by") @db.Uuid
  updatedBy       String?  @map("updated_by") @db.Uuid

  // Soft delete (PIIBEL standard)
  deletedAt       DateTime? @map("deleted_at")
  deletedBy       String?   @map("deleted_by") @db.Uuid

  // Relations
  vault           FileVault @relation(fields: [vaultId], references: [id], onDelete: Cascade)
  folder          FileFolder? @relation(fields: [folderId], references: [id])
  parentFile      File? @relation("FileVersions", fields: [parentFileId], references: [id])
  versions        File[] @relation("FileVersions")
  shares          FileShare[]
  accesses        FileAccess[]
  tags            FileTag[]
  permissions     FilePermission[]

  @@unique([vaultId, path])
  @@index([vaultId])
  @@index([folderId])
  @@index([ownerId])
  @@index([storageKey])
  @@index([checksumMd5])
  @@index([indexedAt])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("files")
}

// File Share (Sharing links)
model FileShare {
  id              String   @id @default(uuid()) @db.Uuid
  vaultId         String   @map("vault_id") @db.Uuid
  fileId          String?  @map("file_id") @db.Uuid
  folderId        String?  @map("folder_id") @db.Uuid

  // Share link
  shortCode       String   @unique @map("short_code") // e.g., "abc123"

  // Permissions
  permission      SharePermission

  // Security
  passwordHash    String?  @map("password_hash")
  requireEmail    Boolean  @default(false) @map("require_email")
  allowedEmails   String[] @map("allowed_emails")

  // Limits
  expiresAt       DateTime? @map("expires_at")
  maxDownloads    Int?     @map("max_downloads")
  downloadCount   Int      @default(0) @map("download_count")

  // Tracking
  viewCount       Int      @default(0) @map("view_count")
  lastAccessedAt  DateTime? @map("last_accessed_at")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  createdBy       String   @map("created_by") @db.Uuid

  // Relations
  vault           FileVault @relation(fields: [vaultId], references: [id], onDelete: Cascade)
  file            File? @relation(fields: [fileId], references: [id], onDelete: Cascade)
  folder          FileFolder? @relation(fields: [folderId], references: [id], onDelete: Cascade)
  accesses        FileAccess[]

  @@index([vaultId])
  @@index([fileId])
  @@index([folderId])
  @@index([shortCode])
  @@index([expiresAt])
  @@map("file_shares")
}

// File Access (Access logs)
model FileAccess {
  id              String   @id @default(uuid()) @db.Uuid
  fileId          String?  @map("file_id") @db.Uuid
  shareId         String?  @map("share_id") @db.Uuid

  // Access details
  action          FileAction
  ipAddress       String   @map("ip_address")
  userAgent       String?  @map("user_agent")
  userId          String?  @map("user_id") @db.Uuid

  // Bandwidth tracking
  bytesTransferred BigInt? @map("bytes_transferred")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  file            File? @relation(fields: [fileId], references: [id], onDelete: Cascade)
  share           FileShare? @relation(fields: [shareId], references: [id], onDelete: Cascade)

  @@index([fileId])
  @@index([shareId])
  @@index([userId])
  @@index([createdAt])
  @@map("file_accesses")
}

// File Tag (Tagging system)
model FileTag {
  id              String   @id @default(uuid()) @db.Uuid
  fileId          String   @map("file_id") @db.Uuid
  tag             String

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  file            File @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@unique([fileId, tag])
  @@index([tag])
  @@map("file_tags")
}

// File Upload Session (Chunked uploads)
model FileUploadSession {
  id              String   @id @default(uuid()) @db.Uuid
  vaultId         String   @map("vault_id") @db.Uuid

  // File info
  filename        String
  sizeBytes       BigInt   @map("size_bytes")
  mimeType        String   @map("mime_type")

  // Upload progress
  chunkSize       Int      @default(5242880) @map("chunk_size") // 5MB
  totalChunks     Int      @map("total_chunks")
  uploadedChunks  Int[]    @map("uploaded_chunks")

  // Storage
  storageProvider String   @map("storage_provider")
  storageBucket   String   @map("storage_bucket")
  storageKey      String   @map("storage_key")
  uploadId        String?  @map("upload_id") // S3 multipart upload ID

  // Metadata
  metadata        Json     @default("{}")

  // Status
  status          UploadStatus @default(in_progress)
  errorMessage    String?  @map("error_message")

  // Resume token
  resumeToken     String   @unique @map("resume_token")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  expiresAt       DateTime @map("expires_at") // Auto-cleanup

  @@index([vaultId])
  @@index([resumeToken])
  @@index([expiresAt])
  @@map("file_upload_sessions")
}

// Storage Quota (Tracking)
model StorageQuota {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @unique @map("tenant_id") @db.Uuid
  userId          String?  @unique @map("user_id") @db.Uuid

  // Limits
  quotaBytes      BigInt   @map("quota_bytes")
  usedBytes       BigInt   @default(0) @map("used_bytes")
  fileCount       Int      @default(0) @map("file_count")

  // Warnings
  warningSentAt   DateTime? @map("warning_sent_at")
  limitReachedAt  DateTime? @map("limit_reached_at")

  // Timestamps
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([userId])
  @@map("storage_quotas")
}

// =============================================
// INTERNAL SHARING - Team & User Permissions
// =============================================

// Enum for permission types
enum FilePermissionType {
  view         // Can view only
  comment      // Can view + comment
  download     // Can view + download
  edit         // Can view + download + edit metadata
  manage       // Can view + download + edit + share + delete
  owner        // Full control
}

enum TeamRole {
  member
  admin
}

// File Permission (Internal sharing with users/teams)
model FilePermission {
  id          String   @id @default(uuid()) @db.Uuid
  fileId      String?  @map("file_id") @db.Uuid
  folderId    String?  @map("folder_id") @db.Uuid

  // WHO has access
  userId      String?  @map("user_id") @db.Uuid    // Specific user
  teamId      String?  @map("team_id") @db.Uuid    // Entire team
  role        String?                               // Role-based (e.g., "admin")

  // WHAT they can do
  permission  FilePermissionType

  // WHEN it expires
  expiresAt   DateTime? @map("expires_at")

  // Audit
  createdAt   DateTime @default(now()) @map("created_at")
  createdBy   String   @map("created_by") @db.Uuid

  // Relations
  file        File? @relation(fields: [fileId], references: [id], onDelete: Cascade)
  folder      FileFolder? @relation(fields: [folderId], references: [id], onDelete: Cascade)
  team        FileTeam? @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([fileId, userId])
  @@unique([fileId, teamId])
  @@unique([folderId, userId])
  @@unique([folderId, teamId])
  @@index([fileId])
  @@index([folderId])
  @@index([userId])
  @@index([teamId])
  @@map("file_permissions")
}

// Team for file sharing
model FileTeam {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  name        String
  description String?

  // Timestamps & Audit (PIIBEL standard)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdBy   String   @map("created_by") @db.Uuid
  updatedBy   String?  @map("updated_by") @db.Uuid

  // Soft delete (PIIBEL standard)
  deletedAt   DateTime? @map("deleted_at")
  deletedBy   String?   @map("deleted_by") @db.Uuid

  // Relations
  tenant      Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  members     FileTeamMember[]
  permissions FilePermission[]

  @@index([tenantId])
  @@index([deletedAt])
  @@map("file_teams")
}

// Team membership
model FileTeamMember {
  id          String   @id @default(uuid()) @db.Uuid
  teamId      String   @map("team_id") @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  role        TeamRole @default(member)

  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  team        FileTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([userId])
  @@map("file_team_members")
}
