# RIVEST FILE VAULT - ADVANCED FEATURES & EXTREME SCALE

**Lisafunktsionaalsused + 1M+ Failide Optimiseerimine**

Loodud: 29. November 2025

---

## ğŸ“‹ SISUKORD

1. [Puuduvad Funktsioonid](#1-puuduvad-funktsioonid)
2. [1M+ Failide JÃµudlus](#2-1m-failide-jÃµudlus)
3. [TÃ¤psem Otsing](#3-tÃ¤psem-otsing)
4. [KoostÃ¶Ã¶ Funktsioonid](#4-koostÃ¶Ã¶-funktsioonid)
5. [Automaatika](#5-automaatika)
6. [AI Funktsioonid](#6-ai-funktsioonid)
7. [Integratsioonid](#7-integratsioonid)
8. [Mobile & Offline](#8-mobile--offline)
9. [Compliance](#9-compliance)
10. [Prioriteedid](#10-prioriteedid)

---

## 1. PUUDUVAD FUNKTSIOONID

### 1.1 VÃµrdlus Konkurentidega

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  FUNKTSIOON            Dropbox  GDrive  Box  Notion  RIVEST     â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  FILE STORAGE             âœ…      âœ…     âœ…    âœ…      âœ…         â•‘
â•‘  TABLE VIEW               âŒ      âŒ     âŒ    âš ï¸      âœ…         â•‘
â•‘  CUSTOM METADATA          âŒ      âŒ     âŒ    âŒ      âœ…         â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•‘
â•‘  PUUDU RIVEST'IS:                                               â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•‘
â•‘  Real-time Collab         âœ…      âœ…     âœ…    âœ…      âŒ TODO   â•‘
â•‘  Comments                 âœ…      âœ…     âœ…    âœ…      âŒ TODO   â•‘
â•‘  @Mentions                âœ…      âœ…     âœ…    âœ…      âŒ TODO   â•‘
â•‘  Activity Feed            âœ…      âœ…     âœ…    âœ…      âŒ TODO   â•‘
â•‘  Notifications            âœ…      âœ…     âœ…    âœ…      âŒ TODO   â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•‘
â•‘  Full-Text Search         âœ…      âœ…     âœ…    âœ…      âŒ TODO   â•‘
â•‘  OCR Search               âš ï¸      âœ…     âœ…    âŒ      âŒ TODO   â•‘
â•‘  AI Semantic Search       âŒ      âš ï¸     âš ï¸    âŒ      âŒ TODO   â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•‘
â•‘  Automation               âš ï¸      âŒ     âœ…    âš ï¸      âŒ TODO   â•‘
â•‘  Workflows                âŒ      âŒ     âœ…    âŒ      âŒ TODO   â•‘
â•‘  Webhooks                 âœ…      âœ…     âœ…    âœ…      âŒ TODO   â•‘
â•‘  Zapier                   âœ…      âœ…     âœ…    âœ…      âŒ TODO   â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•‘
â•‘  Mobile App               âœ…      âœ…     âœ…    âœ…      âŒ TODO   â•‘
â•‘  Offline Mode             âœ…      âœ…     âœ…    âœ…      âŒ TODO   â•‘
â•‘  Camera Upload            âœ…      âœ…     âœ…    âŒ      âŒ TODO   â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•‘
â•‘  Version Diff             âš ï¸      âš ï¸     âœ…    âŒ      âŒ TODO   â•‘
â•‘  PDF Annotation           âŒ      âŒ     âœ…    âŒ      âŒ TODO   â•‘
â•‘  Embed in Website         âœ…      âœ…     âœ…    âœ…      âŒ TODO   â•‘
â•‘  QR Code Sharing          âŒ      âŒ     âŒ    âŒ      âŒ TODO   â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•‘
â•‘  Approval Workflows       âŒ      âŒ     âœ…    âŒ      âŒ TODO   â•‘
â•‘  E-Signatures             âŒ      âŒ     âœ…    âŒ      âš ï¸        â•‘
â•‘  Audit Logs               âš ï¸      âš ï¸     âœ…    âŒ      âš ï¸        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### 1.2 Prioriteedid

**P0 (CRITICAL for 1M+ files):**
```
1. â­ ElasticSearch / Typesense Integration
2. â­ Smart Pagination & Infinite Scroll
3. â­ Background Indexing
4. â­ Full-Text Search (PDFs, DOCX)
5. â­ Faceted Filters (type, project, status)
```

**P1 (HIGH PRIORITY):**
```
6. Real-time Collaboration (Supabase Realtime)
7. Comments System (on files)
8. @Mentions & Notifications
9. Activity Feed (who did what)
10. Automation/Workflows (if file uploaded, then...)
```

**P2 (NICE TO HAVE):**
```
11. Mobile Apps (React Native)
12. Offline Mode (Service Workers)
13. OCR Search (Tesseract.js)
14. AI Semantic Search (OpenAI Embeddings)
15. Version Diff Viewer
16. PDF Annotation
```

**P3 (FUTURE):**
```
17. Zapier Integration
18. Custom Domain Sharing
19. Branded Share Pages
20. Advanced Analytics Dashboard
21. AI Auto-Tagging
22. Video Transcoding
23. Image Editing
24. Approval Workflows
```

---

## 2. 1M+ FAILIDE JÃ•UDLUS

### 2.1 Probleem

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PRAEGUNE LÃ„HENEMINE (tÃ¶Ã¶tab kuni ~100k faili)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  SELECT * FROM files WHERE vault_id = ?              â”‚
â”‚  â†’ Laadi kÃµik failid mÃ¤llu                           â”‚
â”‚  â†’ Virtual scrolling renderib visuaalselt           â”‚
â”‚                                                      â”‚
â”‚  PROBLEEMID 1M+ FAILIGA:                             â”‚
â”‚  âŒ PostgreSQL query: 2-5 sekundit                   â”‚
â”‚  âŒ JSONB scanning: aeglane                          â”‚
â”‚  âŒ Sortimine: kallis                                â”‚
â”‚  âŒ Filtreerimine: full table scan                   â”‚
â”‚  âŒ Otsing: vÃ¤ga aeglane                             â”‚
â”‚  âŒ Esmane laadimine: valulik                        â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Lahendus: 3-Tasandiline Arhitektuur

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TIER 1: OTSINGU INDEX (ElasticSearch/Typesense)            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  EesmÃ¤rk: Kiire otsing ja filtreerimine                     â”‚
â”‚                                                              â”‚
â”‚  â€¢ Full-text search: <50ms                                   â”‚
â”‚  â€¢ Faceted filters: instant                                  â”‚
â”‚  â€¢ Aggregations: kiire                                       â”‚
â”‚  â€¢ Tagastab: ainult ID'd                                     â”‚
â”‚                                                              â”‚
â”‚  NÃ¤ide Query:                                                â”‚
â”‚  "CAD failid projektile RM2506 mis heakskiidetud eelmisel"  â”‚
â”‚  â†’ Tagastab: [id1, id2, id3, ...] 30ms'iga                  â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TIER 2: METADATA CACHE (Redis)                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  EesmÃ¤rk: Instant metadata lookup                            â”‚
â”‚                                                              â”‚
â”‚  â€¢ File metadata: O(1) lookup                                â”‚
â”‚  â€¢ Recent files: cached                                      â”‚
â”‚  â€¢ Popular files: cached                                     â”‚
â”‚  â€¢ TTL: 1 tund                                               â”‚
â”‚                                                              â”‚
â”‚  Cache Structure:                                            â”‚
â”‚  files:meta:{id} â†’ Hash {name, size, type, metadata}        â”‚
â”‚  files:recent:{vault} â†’ Sorted Set by timestamp             â”‚
â”‚  files:popular â†’ Sorted Set by views                        â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TIER 3: DATABASE (PostgreSQL)                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  EesmÃ¤rk: Source of truth                                    â”‚
â”‚                                                              â”‚
â”‚  â€¢ Partitioned tables (by tenant, date)                     â”‚
â”‚  â€¢ Accessed ainult kui vaja                                  â”‚
â”‚  â€¢ Write-through cache                                       â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 Query Flow 1M+ Failiga

```
KASUTAJA QUERY: "NÃ¤ita CAD faile projektile RM2506"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: Search Index (ElasticSearch) - 25ms     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ POST /files/_search                              â”‚
â”‚ {                                                â”‚
â”‚   "query": {                                     â”‚
â”‚     "bool": {                                    â”‚
â”‚       "must": [                                  â”‚
â”‚         { "term": { "extension": "dwg" } },      â”‚
â”‚         { "term": { "metadata.project": "RM..." }}â”‚
â”‚       ]                                          â”‚
â”‚     }                                            â”‚
â”‚   },                                             â”‚
â”‚   "size": 100,                                   â”‚
â”‚   "from": 0                                      â”‚
â”‚ }                                                â”‚
â”‚                                                  â”‚
â”‚ Response:                                        â”‚
â”‚ {                                                â”‚
â”‚   "hits": {                                      â”‚
â”‚     "total": 1247,  â† Kokku leitud              â”‚
â”‚     "hits": [                                    â”‚
â”‚       { "_id": "file_001" },                     â”‚
â”‚       { "_id": "file_002" },                     â”‚
â”‚       ... (100 tk)                               â”‚
â”‚     ]                                            â”‚
â”‚   }                                              â”‚
â”‚ }                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: Fetch Metadata (Redis) - 5ms            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MGET files:meta:file_001 files:meta:file_002 ..â”‚
â”‚                                                  â”‚
â”‚ Response:                                        â”‚
â”‚ [                                                â”‚
â”‚   { name: "drawing1.dwg", size: 2MB, ... },     â”‚
â”‚   { name: "drawing2.dwg", size: 1.5MB, ... },   â”‚
â”‚   ... (100 tk)                                   â”‚
â”‚ ]                                                â”‚
â”‚                                                  â”‚
â”‚ Kui mÃµni puudu? â†’ Load from DB â†’ Cache it       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: Render Table (React) - instant          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Display 100 files in virtual table               â”‚
â”‚ Scroll smooth @ 60fps                            â”‚
â”‚ Prefetch next 100 in background                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

KOKKU: 30ms! âœ… (vs 3-5 sekundit praegu)
```

### 2.4 ElasticSearch Setup

```typescript
// apps/api/src/lib/file-vault/search/elasticsearch.ts

import { Client } from '@elastic/elasticsearch'

export class FileSearchEngine {
  private client: Client
  
  constructor() {
    this.client = new Client({
      node: process.env.ELASTICSEARCH_URL || 'http://localhost:9200'
    })
  }
  
  /**
   * Index single file
   */
  async indexFile(file: File) {
    await this.client.index({
      index: 'files',
      id: file.id,
      document: {
        // Basic info
        name: file.name,
        extension: file.extension,
        mime_type: file.mime_type,
        size_bytes: file.size_bytes,
        
        // Content (extracted text)
        content: await this.extractContent(file),
        
        // Metadata
        metadata: file.metadata,
        
        // Relations
        vault_id: file.vault_id,
        folder_id: file.folder_id,
        owner_id: file.owner_id,
        
        // Timestamps
        created_at: file.created_at,
        updated_at: file.updated_at,
        
        // Tags
        tags: file.tags?.map(t => t.tag) || [],
        
        // Path for hierarchy search
        path: file.path,
      }
    })
  }
  
  /**
   * Bulk index files
   */
  async bulkIndex(files: File[]) {
    const operations = files.flatMap(file => [
      { index: { _index: 'files', _id: file.id } },
      {
        name: file.name,
        extension: file.extension,
        // ... same as above
      }
    ])
    
    await this.client.bulk({ operations })
  }
  
  /**
   * Search files
   */
  async search(params: {
    vaultId: string
    query?: string
    filters?: {
      extension?: string
      project?: string
      status?: string
      dateFrom?: Date
      dateTo?: Date
    }
    page?: number
    pageSize?: number
    sort?: { field: string; order: 'asc' | 'desc' }
  }) {
    const { 
      vaultId,
      query, 
      filters = {},
      page = 0,
      pageSize = 100,
      sort
    } = params
    
    // Build query
    const must: any[] = [
      { term: { vault_id: vaultId } }
    ]
    
    // Text search
    if (query) {
      must.push({
        multi_match: {
          query,
          fields: ['name^3', 'content', 'tags'],
          fuzziness: 'AUTO'
        }
      })
    }
    
    // Filters
    const filter: any[] = []
    
    if (filters.extension) {
      filter.push({ term: { extension: filters.extension } })
    }
    
    if (filters.project) {
      filter.push({ term: { 'metadata.project': filters.project } })
    }
    
    if (filters.status) {
      filter.push({ term: { 'metadata.status': filters.status } })
    }
    
    if (filters.dateFrom || filters.dateTo) {
      filter.push({
        range: {
          created_at: {
            gte: filters.dateFrom,
            lte: filters.dateTo
          }
        }
      })
    }
    
    // Execute search
    const result = await this.client.search({
      index: 'files',
      from: page * pageSize,
      size: pageSize,
      query: {
        bool: { must, filter }
      },
      sort: sort ? [{ [sort.field]: sort.order }] : undefined,
      _source: false, // Only IDs
      
      // Facets for filtering
      aggs: {
        extensions: {
          terms: { field: 'extension', size: 50 }
        },
        projects: {
          terms: { field: 'metadata.project', size: 100 }
        },
        statuses: {
          terms: { field: 'metadata.status', size: 20 }
        }
      }
    })
    
    return {
      fileIds: result.hits.hits.map(hit => hit._id),
      total: result.hits.total.value,
      took: result.took,
      facets: {
        extensions: result.aggregations.extensions.buckets,
        projects: result.aggregations.projects.buckets,
        statuses: result.aggregations.statuses.buckets,
      }
    }
  }
  
  /**
   * Extract text content from file
   */
  private async extractContent(file: File): Promise<string> {
    // PDF
    if (file.mime_type === 'application/pdf') {
      return await extractPdfText(file.storage_path)
    }
    
    // Word documents
    if (file.mime_type.includes('word')) {
      return await extractDocxText(file.storage_path)
    }
    
    // Images (OCR)
    if (file.mime_type.startsWith('image/')) {
      return await extractImageText(file.storage_path)
    }
    
    return ''
  }
}
```

### 2.5 Redis Cache Layer

```typescript
// apps/api/src/lib/file-vault/cache/redis-cache.ts

import { Redis } from 'ioredis'

export class FileMetadataCache {
  private redis: Redis
  
  constructor() {
    this.redis = new Redis(process.env.REDIS_URL)
  }
  
  /**
   * Get file metadata
   */
  async get(fileId: string): Promise<FileMetadata | null> {
    const data = await this.redis.hgetall(`file:${fileId}`)
    
    if (!data || Object.keys(data).length === 0) {
      return null
    }
    
    return {
      id: fileId,
      name: data.name,
      size_bytes: parseInt(data.size_bytes),
      mime_type: data.mime_type,
      metadata: JSON.parse(data.metadata || '{}'),
      created_at: new Date(data.created_at),
      // ... rest
    }
  }
  
  /**
   * Get multiple files
   */
  async getMany(fileIds: string[]): Promise<Record<string, FileMetadata>> {
    const pipeline = this.redis.pipeline()
    
    fileIds.forEach(id => {
      pipeline.hgetall(`file:${id}`)
    })
    
    const results = await pipeline.exec()
    
    const files: Record<string, FileMetadata> = {}
    
    results?.forEach((result, idx) => {
      const [err, data] = result
      if (!err && data && Object.keys(data).length > 0) {
        files[fileIds[idx]] = this.parseMetadata(fileIds[idx], data)
      }
    })
    
    return files
  }
  
  /**
   * Set file metadata
   */
  async set(file: File) {
    const key = `file:${file.id}`
    
    await this.redis.hmset(key, {
      name: file.name,
      size_bytes: file.size_bytes.toString(),
      mime_type: file.mime_type,
      extension: file.extension,
      metadata: JSON.stringify(file.metadata),
      owner_id: file.owner_id,
      created_at: file.created_at.toISOString(),
      updated_at: file.updated_at.toISOString(),
    })
    
    // Set expiry (1 hour)
    await this.redis.expire(key, 3600)
    
    // Add to recent files
    await this.redis.zadd(
      `vault:${file.vault_id}:recent`,
      Date.now(),
      file.id
    )
  }
  
  /**
   * Invalidate cache
   */
  async invalidate(fileId: string) {
    await this.redis.del(`file:${fileId}`)
  }
  
  /**
   * Get recent files
   */
  async getRecent(vaultId: string, limit: number = 100): Promise<string[]> {
    return await this.redis.zrevrange(
      `vault:${vaultId}:recent`,
      0,
      limit - 1
    )
  }
}
```

### 2.6 Smart Pagination

```typescript
// apps/web/src/lib/file-vault/pagination/smart-paginator.ts

export class SmartPaginator {
  private searchEngine: FileSearchEngine
  private cache: FileMetadataCache
  private db: PrismaClient
  
  async loadPage(params: {
    vaultId: string
    query?: string
    filters?: SearchFilters
    page: number
    pageSize: number
  }): Promise<PaginatedFiles> {
    const { vaultId, query, filters, page, pageSize } = params
    
    // 1. Search for file IDs (ElasticSearch)
    const searchResult = await this.searchEngine.search({
      vaultId,
      query,
      filters,
      page,
      pageSize
    })
    
    const fileIds = searchResult.fileIds
    
    // 2. Try to get metadata from cache (Redis)
    const cachedFiles = await this.cache.getMany(fileIds)
    
    // 3. Fetch missing files from database
    const missingIds = fileIds.filter(id => !cachedFiles[id])
    
    let dbFiles: File[] = []
    if (missingIds.length > 0) {
      dbFiles = await this.db.file.findMany({
        where: { id: { in: missingIds } }
      })
      
      // Cache them for next time
      await Promise.all(
        dbFiles.map(file => this.cache.set(file))
      )
    }
    
    // 4. Merge results in correct order
    const files = fileIds.map(id => 
      cachedFiles[id] || dbFiles.find(f => f.id === id)
    ).filter(Boolean)
    
    // 5. Prefetch next page in background
    this.prefetchNextPage(params, page + 1)
    
    return {
      files,
      total: searchResult.total,
      page,
      pageSize,
      hasMore: (page + 1) * pageSize < searchResult.total,
      facets: searchResult.facets,
      took: searchResult.took
    }
  }
  
  private async prefetchNextPage(
    params: any,
    nextPage: number
  ) {
    // Run in background (don't await)
    setTimeout(async () => {
      const result = await this.searchEngine.search({
        ...params,
        page: nextPage,
        pageSize: params.pageSize * 2 // Prefetch 2x
      })
      
      // Warm up cache
      const files = await this.db.file.findMany({
        where: { id: { in: result.fileIds } }
      })
      
      await Promise.all(files.map(f => this.cache.set(f)))
    }, 100)
  }
}
```

### 2.7 Performance Metrics

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  OPERATION            CURRENT     WITH OPTIMIZATION       â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Initial Load         3-5s        <200ms              âœ…  â•‘
â•‘  Search               2-4s        <50ms               âœ…  â•‘
â•‘  Filter               1-3s        <30ms               âœ…  â•‘
â•‘  Sort                 2-5s        <50ms               âœ…  â•‘
â•‘  Pagination           500ms       <20ms               âœ…  â•‘
â•‘  Scroll (next)        300ms       <10ms (prefetched)  âœ…  â•‘
â•‘  Metadata Update      100ms       <100ms              âœ…  â•‘
â•‘  Complex Search       5-10s       <80ms               âœ…  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1M files = 30-50ms response time! ğŸš€
```

---

## 3. COLLABORATION FEATURES

### 3.1 Real-time Updates (Supabase Realtime)

```typescript
// apps/web/src/lib/file-vault/realtime/file-sync.ts

export function useFileSyncsupabaseUrl('vaultId: string) {
  const { data: files, mutate } = useFiles(vaultId)
  
  useEffect(() => {
    const channel = supabase
      .channel(`vault:${vaultId}`)
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'File',
          filter: `vault_id=eq.${vaultId}`
        },
        (payload) => {
          if (payload.eventType === 'INSERT') {
            // New file uploaded
            mutate(current => [...current, payload.new], false)
            toast.info(`${payload.new.name} uploaded`)
          }
          
          if (payload.eventType === 'UPDATE') {
            // File updated
            mutate(
              current => current.map(f => 
                f.id === payload.new.id ? payload.new : f
              ),
              false
            )
          }
          
          if (payload.eventType === 'DELETE') {
            // File deleted
            mutate(
              current => current.filter(f => f.id !== payload.old.id),
              false
            )
            toast.info(`${payload.old.name} deleted`)
          }
        }
      )
      .subscribe()
    
    return () => {
      supabase.removeChannel(channel)
    }
  }, [vaultId])
}
```

### 3.2 Comments System

```prisma
// Add to schema.prisma

model FileComment {
  id         String   @id @default(cuid())
  file_id    String
  user_id    String
  content    String
  
  // Threading
  parent_id  String?
  
  // Mentions
  mentions   String[] // User IDs
  
  // Relations
  file       File @relation(fields: [file_id], references: [id], onDelete: Cascade)
  parent     FileComment? @relation("CommentThread", fields: [parent_id], references: [id])
  replies    FileComment[] @relation("CommentThread")
  
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  
  @@index([file_id])
  @@index([user_id])
}
```

```typescript
// apps/web/src/components/file-vault/FileComments.tsx

export function FileComments({ fileId }: { fileId: string }) {
  const [comment, setComment] = useState('')
  const { data: comments } = useComments(fileId)
  
  const handleSubmit = async () => {
    // Parse @mentions
    const mentions = comment.match(/@\w+/g)?.map(m => m.slice(1)) || []
    
    await createComment({
      fileId,
      content: comment,
      mentions
    })
    
    setComment('')
  }
  
  return (
    <div className="space-y-4">
      {/* Comment input */}
      <div>
        <MentionTextarea
          value={comment}
          onChange={setComment}
          placeholder="Add a comment... (use @ to mention)"
        />
        <Button onClick={handleSubmit}>Comment</Button>
      </div>
      
      {/* Comments list */}
      <div className="space-y-3">
        {comments?.map(comment => (
          <CommentItem key={comment.id} comment={comment} />
        ))}
      </div>
    </div>
  )
}
```

Continue with more advanced features...
